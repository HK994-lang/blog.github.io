<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>文件加密工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 2em;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #444;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 1.5em;
        }
        label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
        input[type="password"], textarea {
            width: 100%;
            padding: 0.8em;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        textarea {
            resize: vertical;
            min-height: 150px;
        }
        button {
            padding: 0.8em 1.5em;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        #qrcode {
            margin-top: 1em;
            padding: 1em;
            border: 1px solid #eee;
            border-radius: 4px;
            display: inline-block;
        }
        .error {
            color: #d9534f;
            margin-top: 0.5em;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>文件加密解密工具</h1>

    <!-- 加密部分 -->
    <section>
        <h2>加密</h2>
        <div class="form-group">
            <label for="originalText">原文:</label>
            <textarea id="originalText" placeholder="在此输入需要加密的内容"></textarea>
        </div>
        <div class="form-group">
            <label for="encryptPassword">密码 (4-64位):</label>
            <input type="password" id="encryptPassword">
            <p class="error" id="encryptError"></p>
        </div>
        <button onclick="encrypt()">加密并生成二维码</button>
        <div id="qrcode"></div>
    </section>

    <hr style="margin: 3em 0;">

    <!-- 解密部分 -->
    <section>
        <h2>解密</h2>
        <div class="form-group">
            <label for="cipherText">密文:</label>
            <textarea id="cipherText" placeholder="在此输入需要解密的内容"></textarea>
        </div>
        <div class="form-group">
            <label for="decryptPassword">密码:</label>
            <input type="password" id="decryptPassword">
        </div>
        <div class="form-group">
            <label for="verificationCode">128位验证码:</label>
            <input type="text" id="verificationCode" placeholder="输入二维码中的验证码">
             <p class="error" id="decryptError"></p>
        </div>
        <button onclick="decrypt()">解密</button>
        <div class="form-group" style="margin-top: 1em;">
            <label>解密后的原文:</label>
            <textarea id="decryptedText" readonly style="background-color: #f9f9f9;"></textarea>
        </div>
    </section>
</div>

<!-- 引入 CryptoJS 和 QRCode.js 库 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
    function encrypt() {
        const originalText = document.getElementById('originalText').value;
        const password = document.getElementById('encryptPassword').value;
        const errorElement = document.getElementById('encryptError');
        errorElement.textContent = '';

        if (password.length < 4 || password.length > 64) {
            errorElement.textContent = '密码长度必须在4到64位之间。';
            return;
        }

        if (!originalText) {
            errorElement.textContent = '原文不能为空。';
            return;
        }

        // 1. 生成128位的随机验证码
        const verificationCode = CryptoJS.lib.WordArray.random(16).toString(); // 16 * 8 = 128 bits

        // 2. 使用密码和验证码组合作为密钥进行加密
        const key = CryptoJS.PBKDF2(password, verificationCode, {
            keySize: 256 / 32,
            iterations: 1000
        });

        const iv = CryptoJS.lib.WordArray.random(128 / 8);
        const encrypted = CryptoJS.AES.encrypt(originalText, key, {
            iv: iv,
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC
        });

        // 3. 准备下载的内容：iv + 密文
        const cipherText = iv.toString(CryptoJS.enc.Hex) + encrypted.toString();
        
        // 4. 创建并触发下载
        const blob = new Blob([cipherText], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'encrypted-file.txt';
        link.click();

        // 5. 生成包含验证码的二维码
        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = ''; // 清空之前的二维码
        new QRCode(qrcodeContainer, {
            text: verificationCode,
            width: 128,
            height: 128,
        });
    }

    function decrypt() {
        const cipherText = document.getElementById('cipherText').value;
        const password = document.getElementById('decryptPassword').value;
        const verificationCode = document.getElementById('verificationCode').value;
        const decryptedTextElement = document.getElementById('decryptedText');
        const errorElement = document.getElementById('decryptError');
        errorElement.textContent = '';
        decryptedTextElement.value = '';

        if (!cipherText || !password || !verificationCode) {
            errorElement.textContent = '密文、密码和验证码均不能为空。';
            return;
        }

        if (verificationCode.length !== 32) { // 128 bits = 32 hex characters
            errorElement.textContent = '验证码格式不正确，应为32位十六进制字符串。';
            return;
        }
        
        try {
            // 1. 从密文中分离IV
            const ivHex = cipherText.substring(0, 32);
            const encryptedHex = cipherText.substring(32);
            const iv = CryptoJS.enc.Hex.parse(ivHex);

            // 2. 使用密码和验证码生成密钥
            const key = CryptoJS.PBKDF2(password, verificationCode, {
                keySize: 256 / 32,
                iterations: 1000
            });

            // 3. 解密
            const decrypted = CryptoJS.AES.decrypt(encryptedHex, key, {
                iv: iv,
                padding: CryptoJS.pad.Pkcs7,
                mode: CryptoJS.mode.CBC
            });

            const decryptedText = decrypted.toString(CryptoJS.enc.Utf8);

            if (decryptedText) {
                decryptedTextElement.value = decryptedText;
            } else {
                errorElement.textContent = '解密失败，请检查密码或验证码是否正确。';
            }
        } catch (e) {
            errorElement.textContent = '解密过程中发生错误，请检查输入内容。';
            console.error(e);
        }
    }
</script>

</body>
</html>
